@page "/student/create"
@page "/student/edit/{StudentId:int}"
@using System.Text.Json;
@using BlazorStudent.Shared.Dtos;
@inject HttpClient http


@if (StudentId>0)
{
    <StudentForm StudentId="StudentId" HeaderPage="Edit Student" Student="student" OnValidSubmit="UpdateStudent" />
}
else
{
    <StudentForm  StudentId="0" HeaderPage="Add Student" Student="student" OnValidSubmit="CreateStudent"/>
}
@if (message!=null)
{
    <h3>@message</h3>
}

@code{
    [Parameter] public int StudentId { get; set; }
    Student student = new Student();
    string? message=null;
    protected override async Task OnInitializedAsync()
    {
        if (StudentId>0)
        {
            student = await http.GetFromJsonAsync<Student>($"/StudentService/Get/{StudentId}");
        }
    }
    async Task CreateStudent()
    {
        if (student.Fname.Length<3)
        {
            message = "نام کوتاه می باشد";
            StateHasChanged();
            return;
        }
        try
        {
            var result = await http.PostAsJsonAsync("StudentService", student);
            var xx = await result.Content.ReadAsStringAsync();
            var data = JsonSerializer.Deserialize<ResultDto>(xx);
            if (data.isSuccess)
            {
                message = "Saved";
            }
            else
            {
                message = data?.message;
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {

            message = ex.Message;
        }
       
     
    }
    async Task UpdateStudent()
    {
        try
        {
            var result = await http.PostAsJsonAsync("StudentService/Update", student);
            var xx = await result.Content.ReadAsStringAsync();
            var data = JsonSerializer.Deserialize<ResultDto>(xx);
            if (data.isSuccess)
            {
                message = "Saved";
            }
            else
            {
                message = data?.message;
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {

            message = ex.Message;
        }
    }
}

